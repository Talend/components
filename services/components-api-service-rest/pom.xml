<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.talend.daikon</groupId>
        <artifactId>service-parent</artifactId>
        <version>0.23.0</version>
        <relativePath></relativePath>
    </parent>

    <groupId>org.talend.components</groupId>
    <artifactId>components-api-service-rest</artifactId>
    <version>0.23.5-SNAPSHOT</version>

    <name>Component REST API</name>
    <properties>
        <maven.build.timestamp.format>yyyyMMdd-HHmm</maven.build.timestamp.format>
        <java.version>1.8</java.version>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>

        <!-- repositories -->
        <talend.snapshots.repo>https://artifacts-oss.talend.com/nexus/content/repositories/TalendOpenSourceSnapshot/</talend.snapshots.repo>
        <talend.releases.repo>https://artifacts-oss.talend.com/nexus/content/repositories/TalendOpenSourceRelease/</talend.releases.repo>
        <spring.releases.repo>https://repo.spring.io/libs-release/</spring.releases.repo>

        <components.version>0.24-SNAPSHOT</components.version>
        <daikon.version>0.27.0</daikon.version>
        <!-- Used for Docker images name -->
        <git_branch>local</git_branch>
        <talend_docker_registry>registry.datapwn.com</talend_docker_registry>
        <jackson.version>2.9.5</jackson.version>
        <jackson.version.annotations>2.9.0</jackson.version.annotations>
    </properties>
    <url>https://github.com/Talend/components/tree/master/services/components-api-service-rest</url>
    <organization>
        <name>Talend</name>
        <url>http://www.talend.com</url>
    </organization>

    <dependencies>

        <!-- spring dependencies -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jetty</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>org.slf4j</groupId>
                    <artifactId>log4j-over-slf4j</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-tomcat</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <!-- added explicytly cause it is in the scope provided by the parent -->
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <!-- talend dependencies -->
        <dependency>
            <groupId>org.talend.components</groupId>
            <artifactId>components-api-service-spi</artifactId>
            <version>${components.version}</version>
        </dependency>
        <dependency>
            <groupId>org.talend.components</groupId>
            <artifactId>components-common</artifactId>
            <version>${components.version}</version>
        </dependency>
        <dependency>
            <groupId>biz.aQute.bnd</groupId>
            <artifactId>annotation</artifactId>
            <version>2.4.0</version>
        </dependency>
        <dependency>
            <groupId>commons-io</groupId>
            <artifactId>commons-io</artifactId>
        </dependency>
        <dependency>
            <groupId>com.google.guava</groupId>
            <artifactId>guava</artifactId>
            <version>20.0</version>
        </dependency>
        <dependency>
            <groupId>org.ops4j.pax.url</groupId>
            <artifactId>pax-url-aether</artifactId>
            <version>2.6.2</version>
        </dependency>
        <!-- provides layouts for logging. It is not really compile dependency, 
            but rather runtime -->
        <dependency>
            <groupId>org.talend.daikon</groupId>
            <artifactId>logging-event-layout</artifactId>
            <version>${daikon.version}</version>
        </dependency>

        <!-- tests dependencies -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.talend.components</groupId>
            <artifactId>components-api-service-common</artifactId>
            <version>${components.version}</version>
            <classifier>tests</classifier>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.jayway.restassured</groupId>
            <artifactId>rest-assured</artifactId>
            <version>2.6.0</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.hamcrest</groupId>
            <artifactId>hamcrest-all</artifactId>
            <version>1.3</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.talend.components</groupId>
            <artifactId>components-jdbc-runtime</artifactId>
            <version>${components.version}</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-jdbc</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.talend.daikon</groupId>
            <artifactId>daikon</artifactId>
            <version>${daikon.version}</version>
            <classifier>tests</classifier>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.talend.daikon</groupId>
            <artifactId>daikon-spring-utils</artifactId>
            <version>${daikon.version}</version>
            <scope>test</scope>
        </dependency>
        <!-- Drivers needed for embedded database -->
        <dependency>
            <groupId>org.apache.derby</groupId>
            <artifactId>derby</artifactId>
            <version>10.12.1.1</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.apache.derby</groupId>
            <artifactId>derbyclient</artifactId>
            <version>10.12.1.1</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-core</artifactId>
            <version>${jackson.version}</version>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-annotations</artifactId>
            <version>${jackson.version.annotations}</version>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>${jackson.version}</version>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.module</groupId>
            <artifactId>jackson-module-scala_2.10</artifactId>
            <version>${jackson.version}</version>
        </dependency>
    </dependencies>
    <!-- dependencyManagement block may be added here and components bom
        may be included to manage versions -->
    <build>
        <plugins>
            <!-- To get the GIT information for version endpoint. -->
            <plugin>
                <groupId>pl.project13.maven</groupId>
                <artifactId>git-commit-id-plugin</artifactId>
                <version>2.2.4</version>
            </plugin>

            <plugin>
                <!-- prevent spring plugin to create a big startable jar -->
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <configuration>
                            <skip>true</skip>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <!-- generate the maven repo for the service app -->
                <artifactId>maven-invoker-plugin</artifactId>
                <version>2.0.1-TALEND</version>
                <configuration>
                    <localRepositoryPath>target/.m2</localRepositoryPath>
                    <onlyResolveDependencies>true</onlyResolveDependencies>
                </configuration>
                <executions>
                    <execution>
                        <id>generate-service-maven-repo</id>
                        <phase>package</phase>
                        <goals>
                            <goal>install</goal>
                        </goals>
                        <configuration>
                            <pomIncludes>
                                <pomInclude>*/pom.xml</pomInclude>
                            </pomIncludes>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <executions>
                    <!-- create an executable jar only with rest service 
                        classes, excluding configuration but using the maven repo classpath files -->
                    <execution>
                        <id>default-jar</id>
                        <phase>package</phase>
                        <goals>
                            <goal>jar</goal>
                        </goals>
                        <configuration>
                            <classesDirectory>${project.build.outputDirectory}</classesDirectory>
                            <excludes>
                                <exclude>**/application*.properties</exclude>
                                <exclude>**/logback-spring.xml</exclude>
                                <exclude>**/settings.xml</exclude>
                            </excludes>
                            <archive>
                                <manifest>
                                    <addClasspath>true</addClasspath>
                                    <classpathPrefix>.m2/</classpathPrefix>
                                    <classpathLayoutType>repository</classpathLayoutType>
                                    <useUniqueVersions>false</useUniqueVersions><!-- 
                                        to avoid time stamped snapshots -->
                                    <mainClass>org.talend.components.service.rest.Application</mainClass>
                                </manifest>
                            </archive>
                        </configuration>
                    </execution>
                    <execution>
                        <!-- this lib is exactly the same as the default 
                            jar but it keept here because all component tests depends on it. -->
                        <id>lib-jar</id>
                        <phase>package</phase>
                        <goals>
                            <goal>jar</goal>
                        </goals>
                        <configuration>
                            <classifier>lib</classifier>
                            <classesDirectory>${project.build.outputDirectory}</classesDirectory>
                            <excludes>
                                <exclude>**/application*.properties</exclude>
                                <exclude>**/logback-spring.xml</exclude>
                                <exclude>**/settings.xml</exclude>
                            </excludes>
                        </configuration>
                    </execution>
                    <execution>
                        <!-- generate test jar, I am not sure it enven used -->
                        <id>test-jar</id>
                        <goals>
                            <goal>test-jar</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>com.webcohesion.enunciate</groupId>
                <artifactId>enunciate-maven-plugin</artifactId>
                <configuration>
                    <skipEnunciate>true</skipEnunciate>
                </configuration>
            </plugin>
            <plugin>
                <artifactId>maven-assembly-plugin</artifactId>
                <version>3.0.0</version>
                <executions>
                    <execution>
                        <!-- creates the simple bare service zip -->
                        <id>no-arch-package</id>
                        <phase>package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                        <configuration>
                            <descriptors>
                                <descriptor>assembly/no-arch.xml</descriptor>
                            </descriptors>
                            <appendAssemblyId>false</appendAssemblyId>
                        </configuration>
                    </execution>
                    <execution>
                        <!-- creates config zip package to be used by any 
                            other packaging modules such as as all components -->
                        <id>config-package</id>
                        <phase>package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                        <configuration>
                            <descriptors>
                                <descriptor>assembly/config.xml</descriptor>
                            </descriptors>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <!-- removes jdbc runtime jar from the integration tests 
                    classpath -->
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-failsafe-plugin</artifactId>
                <executions>
                    <execution>
                        <goals>
                            <goal>integration-test</goal>
                            <goal>verify</goal>
                        </goals>
                        <configuration>
                            <classpathDependencyExcludes>
                                <classpathDependencyExclude>org.talend.components:components-jdbc-runtime</classpathDependencyExclude>
                            </classpathDependencyExcludes>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

        </plugins>
        <resources>
            <resource>
                <!-- This enable maven defined variables in banner.txt, application.properties -->
                <directory>src/main/resources</directory>
                <filtering>true</filtering>
            </resource>
        </resources>
    </build>
    <profiles>
        <profile>
            <id>skipTestRun</id>
            <activation>
                <property>
                    <name>skipTests</name>
                </property>
            </activation>
            <properties>
                <really.skip.tests>true</really.skip.tests>
            </properties>
        </profile>
        <profile>
            <id>skipTestItRun</id>
            <activation>
                <property>
                    <name>skipITs</name>
                </property>
            </activation>
            <properties>
                <really.skip.tests>true</really.skip.tests>
            </properties>
        </profile>
        <profile>
            <id>docker</id>
            <activation>
                <activeByDefault>false</activeByDefault>
            </activation>
            <build>
                <plugins>
                    <plugin>
                        <groupId>io.fabric8</groupId>
                        <artifactId>docker-maven-plugin</artifactId>
                        <version>0.26.0</version>
                        <executions>
                            <execution>
                                <id>start</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>build</goal>
                                </goals>
                                <configuration>
                                    <autoPull>once</autoPull>
                                    <images>
                                        <image>
                                            <name>
                                                ${talend_docker_registry}/talend/tcomp-${project.artifactId}
                                            </name>
                                            <build>
                                                <from>${talend_docker_registry}/talend/microservices-base:1.latest</from>
                                                <tags>
                                                    <tag>${project.version}-${maven.build.timestamp}</tag>
                                                </tags>
                                                <ports>
                                                    <port>8989</port>
                                                </ports>
                                                <cmd>
                                                    <exec>
                                                        <arg>/maven/start.sh</arg>
                                                    </exec>
                                                </cmd>
                                                <runCmds>
                                                    <run>apk add --no-cache libc6-compat</run>
                                                    <run>chmod +x /maven/start.sh</run>
                                                </runCmds>
                                                <assembly><!-- includes the 
                                                        artifact generated by the current pom -->
                                                    <descriptor>${project.basedir}/assembly/no-arch.xml</descriptor>
                                                </assembly>
                                                <!-- add filebeat log variable -->
                                                <env>
                                                    <LOG_PATH>/maven/logs</LOG_PATH>
                                                    <FILEBEAT_CONSOLE_OUTPUT>false</FILEBEAT_CONSOLE_OUTPUT>
                                                </env>
                                                <labels>
                                                    <name>Talend Component REST API</name>
                                                    <version>${project.version}</version>
                                                    <com.talend.name>Talend Component REST API</com.talend.name>
                                                    <com.talend.application>tcomp</com.talend.application>
                                                    <com.talend.service>${project.artifactId}</com.talend.service>
                                                    <com.talend.version>${project.version}</com.talend.version>
                                                    <com.talend.git.repositories>https://github.com/talend/components</com.talend.git.repositories>
                                                    <com.talend.git.branches>${git_branch}</com.talend.git.branches>
                                                    <com.talend.git.commits>${git.commid.id}</com.talend.git.commits>
                                                    <com.talend.description>Talend Component REST API</com.talend.description>
                                                    <com.talend.url>https://www.talend.com/</com.talend.url>
                                                    <com.talend.vendor>Talend</com.talend.vendor>
                                                    <com.talend.build-date>${maven.build.timestamp}</com.talend.build-date>
                                                    <com.talend.docker.cmd></com.talend.docker.cmd>
                                                    <com.talend.docker.params></com.talend.docker.params>
                                                    <com.talend.docker.healthcheck></com.talend.docker.healthcheck>
                                                </labels>
                                            </build>
                                        </image>
                                    </images>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>

    <repositories>
        <repository>
            <id>spring-releases</id>
            <url>https://repo.spring.io/libs-release/</url>
        </repository>
        <repository>
            <id>releases</id>
            <url>https://artifacts-oss.talend.com/nexus/content/repositories/TalendOpenSourceRelease/</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>talend_nexus</id>
            <name>snapshots</name>
            <url>https://artifacts-oss.talend.com/nexus/content/repositories/TalendOpenSourceSnapshot/</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>central</id>
            <url>https://repo.maven.apache.org/maven2</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>
</project>
